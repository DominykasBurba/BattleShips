@using BattleShips.Domain
@using BattleShips.Domain.Cells
@using BattleShips.Domain.Proxy
@using BattleShips.Services
@inject GameService Game

<div class="board-frame">
    <div class="board-with-labels">
        <!-- Column headers (A, B, C, etc.) -->
        <div class="column-labels" style="--size:@Board.Size; --cell:34px">
            <div class="label-cell"></div> <!-- Empty corner cell -->
            @for (int c = 0; c < Board.Size; c++)
            {
                <div class="label-cell">@((char)('A' + c))</div>
            }
        </div>
        
        <!-- Board rows with row numbers -->
        @for (int r = 0; r < Board.Size; r++)
        {
            <div class="board-row" style="--size:@Board.Size; --cell:34px">
                <!-- Row number -->
                <div class="label-cell">@(r + 1)</div>
                
                <!-- Board cells -->
                @for (int c = 0; c < Board.Size; c++)
                {
                    var rr = r; var cc = c;                 // capture fix

                    var cell = Board[rr, cc];
                    var css = CellCss(cell, Own, rr, cc);
                    var text = CellText(cell, Own);

                    <CellView CssClass="@css"
                              Text="@text"
                              OnClick="@(() => Click(rr, cc))" />
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public IBoardView Board { get; set; } = default!;
    [Parameter] public bool Own { get; set; }
    [Parameter] public bool Interactable { get; set; } = true;
    [Parameter] public Func<Position, Task>? OnFire { get; set; }

    private Task Click(int r, int c)
    {
        if (!Interactable || Own || OnFire is null) return Task.CompletedTask;

        // â›” block re-clicking a tried cell (hit/miss/sunk)
        if (Board[r, c].IsRevealed) return Task.CompletedTask;

        return OnFire(new Position(r, c));
    }

    private string CellCss(Cell cell, bool own, int row, int col)
    {
        var baseCls = "grid-cell";
        var statusCss = cell.Status switch
        {
            CellStatus.Hit  => $"{baseCls} hit",
            CellStatus.Miss => $"{baseCls} miss",
            CellStatus.Sunk => $"{baseCls} sunk",
            CellStatus.Shielded => $"{baseCls} shielded",
            CellStatus.Ship when own => $"{baseCls} ship",
            _ => baseCls
        };

        // If showing own ships, add skin-based class names for styling
        if (own && cell.Ship is not null && cell.Status == CellStatus.Ship)
        {
            var skin = cell.Ship.Skin;
            if (skin == ShipSkin.Camouflage)
            {
                statusCss += " camo";
            }
        }

        // Add 3x3 preview styling when in 3x3 mode and hovering
        if (Game.ShootingMode == ShootingMode.Salvo3x3 && !own && Interactable)
        {
            // This would need JavaScript hover events to work properly
            // For now, we'll just return the base styling
        }

        return statusCss;
    }

    private static string CellText(Cell cell, bool own) => cell.Status switch
    {
        CellStatus.Hit  => "âœ–",
        CellStatus.Miss => "â€¢",
        CellStatus.Sunk => "â˜’",
        CellStatus.Shielded => "ðŸ›¡",
        CellStatus.Ship when own => "â– ",
        _ => ""
    };
}